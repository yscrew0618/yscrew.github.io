<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>비밀번호 재설정</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f6f9; margin:0; }
    .wrap { max-width:520px; margin:48px auto; padding:24px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:18px; }
    h1 { margin:0 0 6px; color:#111827; font-size:22px; }
    p { margin:0 0 16px; color:#6b7280; font-size:14px; line-height:1.5; }
    label { display:block; margin:12px 0 6px; color:#4b5563; font-size:13px; }

    /* ✅ 입력창이 너무 길어 보이지 않도록 + 가운데 정렬 */
    input {
      width:100%;
      max-width: 360px;
      margin: 0 auto;
      display:block;
      padding:10px 12px;
      border:1px solid #d0d4dd;
      border-radius:10px;
      font-size:14px;
      box-sizing:border-box;
    }

    button{
      margin-top:14px;
      width:100%;
      padding:12px 14px;
      border:1px solid #f5eedc;
      background:#f5eedc;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      box-sizing:border-box;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .err { margin-top:10px; color:#ef4444; font-size:13px; white-space:pre-wrap; }
    .ok { margin-top:10px; color:#10b981; font-size:13px; white-space:pre-wrap; }
    .small { margin-top:10px; color:#6b7280; font-size:12px; line-height:1.5; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .hint { margin-top:8px; color:#6b7280; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>비밀번호 재설정</h1>
      <p>메일로 받은 링크로 들어오셨다면, 아래에서 새 비밀번호를 설정할 수 있습니다.</p>

      <label>새 비밀번호 (6자 이상)</label>
      <input id="pw1" type="password" placeholder="새 비밀번호" autocomplete="new-password" />

      <label>새 비밀번호 확인</label>
      <input id="pw2" type="password" placeholder="새 비밀번호 확인" autocomplete="new-password" />

      <button id="btn">비밀번호 변경</button>

      <div id="msg" class="err" style="display:none;"></div>
      <div id="ok" class="ok" style="display:none;"></div>
      <div id="hint" class="hint" style="display:none;"></div>

      <div class="small">
        문제가 계속되면 링크가 만료되었을 수 있어요.<br>
        앱에서 <b>비밀번호 찾기</b>를 다시 눌러 새 메일을 받아주세요.
      </div>
    </div>
  </div>

<script>
  // ✅ Supabase 설정
  const SUPABASE_URL = "https://qgsmwysdgycbffkoiaiq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnc213eXNkZ3ljYmZma29pYWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDA3NzAsImV4cCI6MjA4MTUxNjc3MH0.H20Z1cWQrcpL7Eri_9xNzxiLdIQQHmJpwftMDEaG7qY";

  const $btn = document.getElementById("btn");
  const $msg = document.getElementById("msg");
  const $ok  = document.getElementById("ok");
  const $hint = document.getElementById("hint");

  function showErr(text) {
    $ok.style.display = "none";
    $msg.style.display = "block";
    $msg.textContent = text;
  }
  function showOk(text) {
    $msg.style.display = "none";
    $ok.style.display = "block";
    $ok.textContent = text;
  }
  function showHint(text) {
    $hint.style.display = "block";
    $hint.textContent = text;
  }

  function parseHashParams() {
    const h = (location.hash || "").replace(/^#/, "");
    const p = new URLSearchParams(h);
    return {
      access_token: p.get("access_token"),
      refresh_token: p.get("refresh_token"),
      type: p.get("type"),
      error: p.get("error"),
      error_code: p.get("error_code"),
      error_description: p.get("error_description"),
    };
  }

  const params = parseHashParams();

  // ---- 1) 링크가 error로 들어온 경우(otp_expired 등) ----
  if (params.error || params.error_description) {
    // Supabase가 보내는 대표 오류를 사용자 친화적으로
    let pretty = `링크 오류: ${params.error || ""}\n${params.error_description || ""}`;
    if ((params.error_code || "").toLowerCase().includes("otp_expired") ||
        (params.error_description || "").toLowerCase().includes("expired")) {
      pretty =
        "링크가 만료되었거나 이미 사용되었습니다.\n\n" +
        "1) 앱에서 [비밀번호 찾기]를 다시 눌러 새 메일을 받으세요.\n" +
        "2) 새 메일의 링크는 한 번만 클릭해주세요.";
    }
    showErr(pretty);
    showHint("현재 URL 해시:\n" + (location.hash || "(없음)"));
    $btn.disabled = true;
  }

  // ---- 2) recovery 링크인지 체크 ----
  // 비밀번호 재설정은 보통 type=recovery 로 옵니다.
  const isRecovery = (params.type || "").toLowerCase() === "recovery";

  if (!params.access_token) {
    // 토큰 자체가 없으면(직접 reset.html 들어온 경우)
    showErr(
      "토큰을 찾을 수 없습니다.\n\n" +
      "이 페이지는 '비밀번호 찾기 메일'의 링크로 들어와야 합니다.\n" +
      "앱에서 [비밀번호 찾기]를 다시 눌러 새 메일을 받아주세요."
    );
    showHint("현재 URL 해시:\n" + (location.hash || "(없음)"));
    $btn.disabled = true;
  } else if (!isRecovery) {
    // 토큰은 있는데 recovery 타입이 아니면(다른 목적 링크)
    showErr(
      "이 링크는 비밀번호 재설정(recovery) 링크가 아닙니다.\n\n" +
      "앱에서 [비밀번호 찾기]를 다시 눌러 받은 메일의 링크로 들어와주세요."
    );
    showHint(`현재 type 값: ${params.type || "(없음)"}`);
    $btn.disabled = true;
  }

  async function updatePassword(newPassword) {
    const url = `${SUPABASE_URL.replace(/\/$/, "")}/auth/v1/user`;
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${params.access_token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ password: newPassword })
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      const msg = (data && (data.msg || data.message || data.error_description || data.error)) || text;
      throw new Error(msg);
    }
    return data;
  }

  $btn.addEventListener("click", async () => {
    const pw1 = document.getElementById("pw1").value.trim();
    const pw2 = document.getElementById("pw2").value.trim();

    // 안전장치
    if (!params.access_token || !isRecovery || params.error || params.error_description) return;

    if (pw1.length < 6) return showErr("비밀번호는 6자 이상으로 입력해주세요.");
    if (pw1 !== pw2) return showErr("비밀번호와 확인 값이 일치하지 않습니다.");

    $btn.disabled = true;
    try {
      await updatePassword(pw1);
      showOk("비밀번호가 변경되었습니다! 이제 앱에서 새 비밀번호로 로그인해주세요.");
      // 보안상 토큰 노출 방지: 해시 제거
      history.replaceState({}, document.title, location.pathname);
    } catch (e) {
      showErr("변경 실패: " + (e?.message || e));
      showHint("팁: 링크가 오래됐거나 여러 번 클릭되면 만료될 수 있어요.\n앱에서 비밀번호 찾기를 다시 눌러 새 메일로 진행해주세요.");
    } finally {
      $btn.disabled = false;
    }
  });
</script>
</body>
</html>
